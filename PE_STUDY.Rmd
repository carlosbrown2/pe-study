---
title: "pe_study"
author: "Carlos Brown"
date: "7/22/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(exact2x2)
library(tidyr)
library(dlookr)
library(exact2x2)
# library(reticulate)

file_saddle <- file.path("saddle.csv")
file_nosaddle <- file.path("nosaddle.csv")
file_all <- file.path('all_types.csv')

df_saddle <- read.csv(file_saddle, header = TRUE)
df_nosaddle <- read.csv(file_nosaddle, header = TRUE)
df_all <- read.csv(file_all, header = TRUE)

paste('Number of data points for saddle:',nrow(df_saddle), sep = ' ')
paste('Number of data points for non-saddle:',nrow(df_nosaddle), sep = ' ')
```

```{r change type to factor}
df_saddle$type <- factor("saddle")
df_nosaddle$type <- factor("non-saddle")
df_all$type <- as.factor(df_all$type)
```


```{r bin by age}
breaks = 5
df_saddle$age_bin <- cut(df_saddle$Age, breaks=breaks)
df_nosaddle$age_bin <- cut(df_nosaddle$Age, breaks=breaks)
df_all$age_bin <- cut(df_all$Age, breaks=breaks)
```

## PE Study

```{r dianose saddle}
diagnose(df_saddle)
```

```{r diagnose non-saddle}
diagnose(df_nosaddle)
```

## Tables

```{r adverse event along 3 dimensions}
table_group <- table(df_all$adverseEvent, df_all$type, df_all$age_bin)
test_mat <- as.matrix(table(df_all$adverseEvent, df_all$type))
test_mat
```

```{r power analysis}
power2x2(30/158, 65/180, n0 = 158, n1 = 180, sig.level = 0.01)
```

Hypothesis test is set based on what constitutes surprise for the doctor
H0: There is no difference in the adverse event odds ratio of saddle vs non-saddle in age and severity controlled groups
H1: H0: There is a difference in the adverse event odds ratio of saddle vs non-saddle in age and severity controlled groups (two sided since no assumption made)

```{r Run Fisher's exact test for entire set}
exact2x2(test_mat, conf.level = 0.99)
```
```{r control for age}
df_one <- df_all %>% filter(age_bin == '(19.9,35]')
exact2x2(as.matrix(table(df_one$adverseEvent, df_one$type)), conf.level = 0.99)
```
```{r}
table(df_one$adverseEvent, df_one$type)
```

```{r control False Discovery Rate using BH or BY}

```

## How predictive are PESI and sPESI?

```{python logit, eval=FALSE, include=FALSE}
import statsmodels.discrete.discrete_model as sm

feat_cols = ['Age','Hight-cm','Weight-kg','HR','SBP','Temp (F)','PA/Aorta Ratio','RV/LV Ratio', 'PESI Class' , 'sPESI (low risk = 0; 1 = 1 or greater)','adverseEvent']

features = df_saddle[feat_cols].dropna()
target = features['adverseEvent']

features.drop(columns='adverseEvent', inplace=True)
logit = sm.Logit(target.values, features.astype(float))
res = logit.fit()

print(res.summary())
```

